var ob=angular.module("Orbit","ngMaterial ngResource ngAnimate hmGestures mousewheel ui.bootstrap".split(" "));
(function(){ob.config(["$mdThemingProvider",function(a){a.theme("grey").primaryPalette("grey")}]).controller("OrbitCtrl",["$scope","$rootScope","Images","$mdDialog","$mdToast","$mdSidenav",function(a,q,d,n,r,v){function w(){var a=window.navigator.userAgent,c=a.indexOf("MSIE ");if(0<c)return parseInt(a.substring(c+5,a.indexOf(".",c)),10);if(0<a.indexOf("Trident/"))return c=a.indexOf("rv:"),parseInt(a.substring(c+3,a.indexOf(".",c)),10);c=a.indexOf("Edge/");return 0<c?parseInt(a.substring(c+5,a.indexOf(".",
c)),10):!1}function t(b,c,e,d){var f=a.xml.getElementsByTagName("PointInteret");a:{for(var h=0;h<f.length;h++)if(f[h].getAttribute("ID")==b){b=h;break a}b=void 0}var f=f[b],h=f.getElementsByTagName("Titre"),g=f.getElementsByTagName("Description");"desc"==c&&(a.tooltip.desc=e,f.removeChild(g[0]),g=a.xml.createElement("Description"),e=a.xml.createCDATASection(e),g.appendChild(e),a.xml.getElementsByTagName("PointInteret")[b].appendChild(g));"titre"==c&&(a.tooltip.title=d,f.removeChild(h[0]),c=a.xml.createElement("Titre"),
d=a.xml.createCDATASection(d),c.appendChild(d),a.xml.getElementsByTagName("PointInteret")[b].appendChild(c))}function p(){var b=a.tooltips.filter(function(b){return b.image==a.angle});a.canvas.addEventListener("mousemove",function(c){var e=a.level,f=d.level[0].width/(a.actualTileWidth*d.level[e].cols),e=d.level[0].height/(a.actualTileHeight*d.level[e].rows),k=(c.pageX-a.canvas.clientWidth/2-a.translaX)*f;c=(c.pageY-a.canvas.clientHeight/2-a.translaY)*e;for(var h=0,g=0;g<b.length;g++){var l=b[g].x/
f+a.translaX+a.canvas.clientWidth/2,m=b[g].y/e+a.translaY+a.canvas.clientHeight/2;if(b[g].image==a.angle&&(k>=Number(b[g].x)-10/a.zoom&&k<=Number(b[g].x)+10/a.zoom?c>=Number(b[g].y)-40/a.zoom&&c<=Number(b[g].y)+10/a.zoom?(a.deleteTitrePop(),a.pointPop("desc",b[g].desc,l,m),a.canvas.style.cursor="default"):h++:h++,h===b.length)){l=document.querySelector("orbitview");if(m=l.querySelector(".descPop"))l.removeChild(m),a.canvas.style.cursor=a.currentCursor;a.isPopDrawn=!1}}})}function u(b){return function(){v(b).toggle();
a.isNavCollapsed=!a.isNavCollapsed}}q.$on("onLoading",function(b,c){a.loading=c});q.$on("onComplete",function(){a.loading=!1});a.init=function(){a.canvas=document.querySelector("#orbit-canvas");a.renderer=a.canvas.getContext("2d");a.level=d.level.length-1;d.loadLevel(a.level);window.onresize=a.resize;a.resize();a.visible=!0;setInterval(function(){a.loadingReso=a.waitingload;a.draw()},40);d.loadLevel(a.level);d.loadxml().then(function(b){if(window.DOMParser){var c=new DOMParser;a.xml=c.parseFromString(b.data,
"text/xml")}else a.xml=new ActiveXObject("Microsoft.XMLDOM"),xml.async="false",xml.loadXML(b);if(a.xml)if(0<a.xml.getElementsByTagName("property").length)for(b=a.xml.getElementsByTagName("property"),c=0;c<b.length;c++)"titre"===b[c].getAttribute("name")&&(a.titre=b[c].textContent),"description"===b[c].getAttribute("name")&&(a.description=b[c].textContent);else d.loadDetails().then(function(b){if(window.DOMParser){var c=new DOMParser;a.details=c.parseFromString(b.data,"text/xml")}else a.details=new ActiveXObject("Microsoft.XMLDOM"),
details.async="false",details.loadXML(b);b=a.details.getElementsByTagName("property");for(c=0;c<b.length;c++)"titre"!==b[c].getAttribute("name")||a.titre||(a.titre=b[c].textContent),"description"!==b[c].getAttribute("name")||a.description||(a.description=b[c].textContent)});b=a.xml.getElementsByTagName("PointInteret");for(c=0;c<b.length;c++){var e=b[c].getElementsByTagName("Titre"),f=b[c].getElementsByTagName("Description"),k=b[c].attributes[0].value,h=b[c].attributes[1].value,g=b[c].getElementsByTagName("Coord")[0].getAttribute("x"),
l=b[c].getElementsByTagName("Coord")[0].getAttribute("y"),e={title:e[0].textContent,desc:f[0].textContent,image:k,x:g,y:l,id:h};a.id++;f=0;for(k=a.tooltips.length;f<k;f++)a.lookupAngle[a.tooltips[f].image]=a.tooltips[f];a.tooltips.push(e)}a.lookupAngle[a.angle]&&p();document.querySelector("#descImage").addEventListener("paste",function(a){setTimeout(function(){var a=document.querySelector("#descImage");a.innerHTML=a.innerHTML.replace(/(&nbsp;|<([^>]+)>)/ig,"")},0)})});a.modeCursor()};a.id=0;a.lookupAngle=
{};a.translaY=0;a.translaX=0;a.prevDeltaX=0;a.prevDeltaY=0;a.pinIcon=new Image;a.pinIcon.src="./resources/icons/pinIcon-32x32.png";a.theme="grey";a.clickRotation=!0;a.clickTranslation=!1;a.pinMode=!1;a.autoPlay=!1;a.isEditMode=!1;a.isFullscreen=!1;a.fsSrc="./resources/icons/icon_fullscreen.png";a.currentCursor="default";a.tooltips=[];a.tooltip=null;a.tooltipTrueCoord={};a.tooltipTitre="";a.tooltipDesc="";a.isPopDrawn=!1;a.loading="0";a.loadingReso=!1;a.waitingload=!0;a.visible=!1;a.zoom=1;a.level=
0;a.angle=0;a.posX=0;a.posY=0;a.actualTileWidth=0;a.actualTileHeight=0;a.isNavCollapsed=!0;a.isCollapsed=!0;a.isTitreCollapsed=!0;a.draw=function(){if(a.waitingload&&d.resourcesLoaded(a.level,a.angle)||a.edited){a.waitingload=!1;a.canvas.width=a.canvas.width;a.renderer.translate(a.translaX,a.translaY);a.renderer.save();var b=a.level,c=d.level[b].resources[a.angle];if(!d.resourcesLoaded(b,a.angle)){a.waitingload=!0;for(d.loadResources(b,a.angle);b<d.level.length-1&&!d.resourcesLoaded(b,a.angle);)b++;
c=d.level[b].resources[a.angle]}for(var b=d.level[b],e=a.getX(),f=a.getY(),k=Math.floor(d.level[0].width/b.cols)*a.zoom,h=Math.floor(d.level[0].height/b.rows)*a.zoom,g=0;g<c.length;g++)a.posX=e+k*Math.floor(g/b.rows),a.posY=f+h*Math.floor(g%b.rows),a.actualTileWidth=c[g].img.naturalWidth*a.zoom*1E3/b.value+1,a.actualTileHeight=c[g].img.naturalHeight*a.zoom*1E3/b.value+1,a.renderer.drawImage(c[g].img,a.posX,a.posY,a.actualTileWidth,a.actualTileHeight);if(a.xml){c=a.xml.getElementsByTagName("PointInteret");
for(b=0;b<c.length;b++)c[b].getAttribute("Angle")==a.angle&&(f=c[b].getElementsByTagName("Coord"),e=Number(f[0].getAttribute("x")),f=Number(f[0].getAttribute("y")),a.renderer.drawImage(a.pinIcon,a.canvas.clientWidth/2+e*a.zoom-16,a.canvas.clientHeight/2+f*a.zoom-32));a.edited=!1}}};a.getX=function(){return+(a.canvas.width/2-d.level[0].width/2*a.zoom).toFixed(0)};a.getY=function(){return-((d.level[0].height*a.zoom-a.canvas.height)/2).toFixed(0)};a.resize=function(){a.resetTransla();a.renderer.restore();
a.canvas.width=a.canvas.offsetWidth;a.canvas.height=a.canvas.offsetHeight;if(!0===a.loading)return!1;a.zoom=a.canvas.width/d.level[0].width<=a.canvas.height/d.level[0].height?a.canvas.width/d.level[0].width:a.canvas.height/d.level[0].height;for(a.level=d.level.length-1;1E3*a.zoom>d.level[a.level].value;)a.level--;a.minZoom=a.zoom;a.maxZoom=1;a.visible&&a.$apply();a.edited=!0};a.toggleGrab=function(){a.pinMode||("-webkit-grab"==a.canvas.style.cursor||"-moz-grab"==a.canvas.style.cursor||"grab"==a.canvas.style.cursor?
(a.canvas.style.cursor="-webkit-grabbing",a.canvas.style.cursor="-moz-grabbing",a.canvas.style.cursor="grabbing"):(a.canvas.style.cursor="-webkit-grab",a.canvas.style.cursor="-moz-grab",a.canvas.style.cursor="grab"))};a.dragStart=function(){a.clickRotation&&!a.clickTranslation&&a.toggleGrab()};a.drag=function(b){if(!a.loading){if(a.clickRotation&&!a.clickTranslation){var c;c=(1*(a.lastDrag-b.gesture.deltaX)/10).toFixed(0);"-0"===c?c=-1:"0"===c&&(c=1);a.lastDrag=b.gesture.deltaX;a.setAngle(a.angle+
parseInt(c))}a.clickTranslation&&!a.clickRotation&&(c=b.gesture.deltaY-a.prevDeltaY,a.incrTranslaX(b.gesture.deltaX-a.prevDeltaX),a.incrTranslaY(c),a.prevDeltaX=b.gesture.deltaX,a.prevDeltaY=b.gesture.deltaY,a.edited=!0)}};a.dragEnd=function(){a.clickRotation&&!a.clickTranslation&&a.toggleGrab();a.prevDeltaX=0;a.prevDeltaY=0};a.goTo=function(b){a.angle!=b?(d.nbAngle-b+a.origAngle<b-a.origAngle?a.setAngle(a.angle-1):a.setAngle(a.angle+1),window.setTimeout(a.goTo,5,b)):document.querySelector(".titrePop")&&
(document.querySelector(".titrePop").style.display="block")};a.keymove=function(b){!a.loading&&a.isNavCollapsed&&(a.clickRotation&&!a.clickTranslation&&(39===b.keyCode&&a.setAngle(a.angle-1),37===b.keyCode&&a.setAngle(a.angle+1)),a.clickTranslation&&!a.clickRotation&&(a.renderer.restore(),a.renderer.save(),37===b.keyCode&&a.incrTranslaX(-10),38===b.keyCode&&a.incrTranslaY(-10),39===b.keyCode&&a.incrTranslaX(10),40===b.keyCode&&a.incrTranslaY(10),a.edited=!0))};a.incrTranslaX=function(b){a.translaX+=
b};a.incrTranslaY=function(b){a.translaY+=b};a.setAngle=function(b){a.angle=b>=d.nbAngle?b-d.nbAngle:0>b?b+d.nbAngle:b;a.lookupAngle[a.angle]&&p();a.edited=!0};a.setTranslaXY=function(b,c){a.translaX=b;a.translaY=c;a.edited=!0};a.resetTransla=function(){a.translaY=0;a.translaX=0;a.edited=!0};a.play=function(){a.autoPlay&&(a.setAngle(a.angle+1),window.setTimeout(a.play,40))};a.toggleFullscreen=function(){var b=document.querySelector("html");a.isFullscreen?(a.fsSrc="./resources/icons/icon_fullscreen_back.png",
b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen()):(a.fsSrc="./resources/icons/icon_fullscreen.png",document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())};a.onWheel=function(b){a.renderer.restore();
var c=a.zoom;0<b.deltaY?a.zoomOut():a.zoomIn();c!=a.zoom&&(a.edited=!0)};a.zoomOut=function(){a.zoom-=.1;a.zoom<a.minZoom&&(a.zoom=a.minZoom);a.level<d.level.length-1&&1E3*a.zoom<=d.level[a.level+1].value&&a.level++;a.edited=!0};a.zoomIn=function(){a.zoom+=.1;a.zoom>=a.maxZoom&&(a.zoom=a.maxZoom);0<a.level&&1E3*a.zoom>d.level[a.level].value&&a.level--;a.edited=!0};a.editMode=function(){a.isEditMode=!a.isEditMode;!1===a.isEditMode&&(a.pinMode=!1)};a.modeCursor=function(){a.pinMode?(a.canvas.style.cursor=
"crosshair",a.currentCursor="crosshair"):(a.clickRotation&&!a.clickTranslation&&(a.canvas.style.cursor="-webkit-grab",a.canvas.style.cursor="-moz-grab",a.canvas.style.cursor="grab",a.currentCursor="grab"),a.clickTranslation&&!a.clickRotation&&(a.canvas.style.cursor="move"),a.currentCursor="move")};a.switchMode=function(){a.clickRotation=!a.clickRotation;a.clickTranslation=!a.clickTranslation;a.modeCursor()};a.exportXML=function(){var b=a.xml.getElementsByTagName("properties")[0];a.xml.getElementsByTagName("sequence")[0].removeChild(b);
var b=a.xml.createElement("properties"),c=a.xml.createElement("property"),e=c.cloneNode(!0);c.setAttribute("name","titre");e.setAttribute("name","description");var d=document.querySelector("#titreImage").innerHTML,k=document.querySelector("#descImage").innerHTML,d=a.xml.createCDATASection(d),k=a.xml.createCDATASection(k);c.appendChild(d);e.appendChild(k);b.appendChild(c);b.appendChild(e);a.xml.getElementsByTagName("sequence")[0].appendChild(b);(b=(new XMLSerializer).serializeToString(a.xml))&&(w()?
window.open().document.write("<textarea style='width: 100%; height: 100%; border:none;'>"+b+"</textarea>"):window.open("data:text/xml,"+encodeURIComponent(b),"Test","width=900,height=900,scrollbars=1,resizable=1"))};a.pin=function(b){if(a.pinMode){a.isNavCollapsed||a.toggleLeft();var c=a.level,e=b.gesture.center.pageX-a.canvas.clientWidth/2-a.translaX;b=b.gesture.center.pageY-a.canvas.clientHeight/2-a.translaY;a.tooltipTrueCoord={x:d.level[0].width/(a.actualTileWidth*d.level[c].cols)*e,y:d.level[0].height/
(a.actualTileHeight*d.level[c].rows)*b};e>a.actualTileWidth*d.level[c].cols/2||e<-a.actualTileWidth*d.level[c].cols/2||b>a.actualTileHeight*d.level[c].rows/2||b<-a.actualTileHeight*d.level[c].rows/2||a.promptPoint()}};a.createTooltip=function(){var b=a.id;a.id++;var c=a.tooltipTitre,e=a.tooltipDesc;a.writePin(c,e,a.angle,a.tooltipTrueCoord,b);a.tooltips.push({title:c,desc:e,image:a.angle,x:a.tooltipTrueCoord.x,y:a.tooltipTrueCoord.y,id:b});b=0;for(c=a.tooltips.length;b<c;b++)a.lookupAngle[a.tooltips[b].image]=
a.tooltips[b];a.lookupAngle[a.angle]&&p();a.edited=!0};a.writePin=function(b,c,e,d,k){var f=a.xml.createElement("PointInteret"),g=a.xml.createElement("Titre"),l=a.xml.createElement("Description"),m=a.xml.createElement("Coord");c=a.xml.createCDATASection(c);b=a.xml.createCDATASection(b);f.setAttribute("Angle",e);f.setAttribute("ID",k);m.setAttribute("x",d.x);m.setAttribute("y",d.y);g.appendChild(b);l.appendChild(c);f.appendChild(g);f.appendChild(l);f.appendChild(m);a.xml.getElementsByTagName("sequence")[0].appendChild(f)};
a.deletePoint=function(b){for(var c={},e=0,d=a.tooltips.length;e<d;e++)c[a.tooltips[e].id]=a.tooltips[e];d=b.target.parentNode.parentNode.parentNode.id;a.tooltip=c[d];a.tooltip.id=d;b=b.target;for(c=[];b;)c.unshift(b),b=b.parentNode;c[7].remove();b=a.tooltips.indexOf(a.tooltip);a.tooltips.splice(b,1);b=0;for(d=a.tooltips.length;b<d;b++)a.lookupAngle[a.tooltips[b].image]=a.tooltips[b];b=a.xml.getElementsByTagName("PointInteret");for(c=0;c<b.length;c++)b[c].getAttribute("Angle")==a.tooltip.image&&b[c].getElementsByTagName("Titre")[0].textContent==
a.tooltip.title&&(d=b[c].getElementsByTagName("Coord")[0],d.getAttribute("x")==a.tooltip.x&&d.getAttribute("y")==a.tooltip.y&&(b[c].parentNode.removeChild(b[c]),a.showSimpleToast()));a.edited=!0};a.toggleEditTooltip=function(b){for(var c={},d=0,f=a.tooltips.length;d<f;d++)c[a.tooltips[d].id]=a.tooltips[d];d=b.target.parentNode.parentNode.parentNode.id;a.tooltip=c[d];a.tooltip.id=d;c=b.target.parentNode.parentNode.parentNode.childNodes[1].childNodes[3];b=b.target.parentNode.parentNode.parentNode.childNodes[3].childNodes[1].childNodes[1].childNodes[1];
"true"==c.contentEditable?(c.setAttribute("contenteditable","false"),t(d,"titre","",c.textContent)):c.setAttribute("contenteditable","true");"true"==b.contentEditable?(b.setAttribute("contenteditable","false"),t(d,"desc",b.textContent,"")):b.setAttribute("contenteditable","true")};a.pointPop=function(b,c,d,f){if(!a.isPopDrawn){var e=document.createElement("div");c=document.createTextNode(c);var h=document.querySelector("orbitview");e.appendChild(c);e.style.marginLeft=d+"px";e.style.marginTop=f+"px";
e.className=b+"Pop";h.appendChild(e);a.isPopDrawn=!0}};a.deleteAllPop=function(){var b=document.querySelector("orbitview"),c=document.querySelector(".titrePop"),d=document.querySelector(".descPop");c&&b.removeChild(c);d&&b.removeChild(d);a.isPopDrawn=!1};a.deleteTitrePop=function(){var a=document.querySelector("orbitview"),c=document.querySelector(".titrePop");c&&a.removeChild(c)};a.clickTooltip=function(b){a.deleteAllPop();for(var c={},e=0,f=a.tooltips.length;e<f;e++)c[a.tooltips[e].id]=a.tooltips[e];
b=b.target.parentNode.parentNode.id;a.tooltip=c[b];a.tooltip.id=b;a.autoPlay=!1;a.pointPop("titre",a.tooltip.title,a.tooltip.x/(d.level[0].width/(a.actualTileWidth*d.level[a.level].cols))+a.translaX+a.canvas.clientWidth/2,a.tooltip.y/(d.level[0].height/(a.actualTileHeight*d.level[a.level].rows))+a.translaY+a.canvas.clientHeight/2);a.origAngle=a.angle;a.goTo(a.tooltip.image)};a.hoverTooltip=function(b){for(var c={},e=0,f=a.tooltips.length;e<f;e++)c[a.tooltips[e].id]=a.tooltips[e];b=b.target.parentNode.parentNode.id;
a.tooltip=c[b];a.tooltip.id=b;a.autoPlay=!1;a.tooltip.image==a.angle&&(a.deleteAllPop(),a.pointPop("titre",a.tooltip.title,a.tooltip.x/(d.level[0].width/(a.actualTileWidth*d.level[a.level].cols))+a.translaX+a.canvas.clientWidth/2,a.tooltip.y/(d.level[0].height/(a.actualTileHeight*d.level[a.level].rows))+a.translaY+a.canvas.clientHeight/2),document.querySelector(".titrePop")&&(document.querySelector(".titrePop").style.display="block"))};a.toggleLeft=u("left");a.toggleRight=u("right");a.confirmDelete=
function(b,c){var d=n.confirm().theme("grey").title("Supprimer ce point d'interet ?").textContent("Vous ne pourrez pas revenir en arri\u00e8re...").ariaLabel("Suppression").targetEvent(b).ok("Supprimer").cancel("Annuler");n.show(d).then(function(){a.deletePoint(b,c)})};a.promptPoint=function(b){n.show({templateUrl:"views/tooltipPrompt.tpl.html",parent:angular.element(document.body),targetEvent:b,controller:"OrbitCtrl",clickOutsideToClose:!0,escapeToClose:!0}).then(function(b){a.tooltipTitre=b.Titre;
a.tooltipDesc=b.Desc;a.createTooltip()})};a.envoyer=function(a){n.hide(a)};a.closeDialog=function(){n.cancel()};a.showSimpleToast=function(){r.show(r.simple().textContent("Point d'interet supprim\u00e9 !").position("top right").hideDelay(3E3))}}])})();

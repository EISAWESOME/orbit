'use strict';ob.service('storageService',['$mdToast',function(e){let t=null;const n=this;this.setXml=function(e){t=e},this.loadXml=function(e,i,r,o,s){let a,l,c;if(window.DOMParser){const e=new DOMParser;n.setXml(e.parseFromString(s.data,'text/xml'))}else n.setXml(new ActiveXObject('Microsoft.XMLDOM')),t.async='false',t.loadXML(s);if(t){if(t.getElementsByTagName('property').length>0){const e=t.getElementsByTagName('property');for(let t=0;t<e.length;t++)'titre'===e[t].getAttribute('name')&&(a=e[t].textContent),'description'===e[t].getAttribute('name')&&(l=e[t].textContent)}else Images.loadDetails().then(function(e){if(window.DOMParser){const t=new DOMParser;c=t.parseFromString(e.data,'text/xml')}else(c=new ActiveXObject('Microsoft.XMLDOM')).async='false',c.loadXML(e);const t=c.getElementsByTagName('property');for(let e=0;e<t.length;e++)'titre'!==t[e].getAttribute('name')||a||(a=t[e].textContent),'description'!==t[e].getAttribute('name')||l||(l=t[e].textContent)});n.setXml(t)}const d=t.getElementsByTagName('PointInteret');for(let e=0;e<d.length;e++){const t=d[e].getElementsByTagName('Titre'),n=d[e].getElementsByTagName('Description'),r=d[e].attributes[0].value,s=d[e].attributes[1].value,a={x:d[e].getElementsByTagName('Coord')[0].getAttribute('x'),y:d[e].getElementsByTagName('Coord')[0].getAttribute('y')},l={title:t[0].textContent,desc:n[0].textContent,image:r,x:a.x,y:a.y,id:s};s++;for(let e=0,t=i.length;e<t;e++)o[i[e].image]=i[e];i.push(l)}return document.querySelector('#descImage').addEventListener('paste',function(e){setTimeout(function(){const e=document.querySelector('#descImage'),t=/(&nbsp;|<([^>]+)>)/gi;e.innerHTML=e.innerHTML.replace(t,'')},0)}),{id:e,titre:a,description:l,details:c}},this.writePin=function(e,n,i,r,o){if(t){const s=t.createElement('PointInteret'),a=t.createElement('Titre'),l=t.createElement('Description'),c=t.createElement('Coord'),d=t.createCDATASection(n),m=t.createCDATASection(e);s.setAttribute('Angle',i),s.setAttribute('ID',o),c.setAttribute('x',r.x),c.setAttribute('y',r.y),a.appendChild(m),l.appendChild(d),s.appendChild(a),s.appendChild(l),s.appendChild(c),t.getElementsByTagName('sequence')[0].appendChild(s)}},this.updatePin=function(e,n,i,r,o){function s(e,t){for(let n=0;n<e.length;n++)if(e[n].getAttribute('ID')==t)return n}const a=t.getElementsByTagName('PointInteret'),l=s(a,e),c=a[l],d=c.getElementsByTagName('Titre'),m=c.getElementsByTagName('Description');if('desc'==n){o.desc=i,c.removeChild(m[0]);const e=t.createElement('Description'),n=t.createCDATASection(i);e.appendChild(n),t.getElementsByTagName('PointInteret')[l].appendChild(e)}if('titre'==n){o.title=r,c.removeChild(d[0]);const e=t.createElement('Titre'),n=t.createCDATASection(r);e.appendChild(n),t.getElementsByTagName('PointInteret')[l].appendChild(e)}},this.deletePin=function(n){function i(){const t='top right';e.show(e.simple().textContent('Point d\'interet supprimÃ© !').position(t).hideDelay(3e3))}const r=t.getElementsByTagName('PointInteret');for(let e=0;e<r.length;e++)if(r[e].getAttribute('Angle')==n.image&&r[e].getElementsByTagName('Titre')[0].textContent==n.title){const t=r[e].getElementsByTagName('Coord')[0];t.getAttribute('x')==n.x&&t.getAttribute('y')==n.y&&(r[e].parentNode.removeChild(r[e]),i())}},this.exportXML=function(){function e(){const e=window.navigator.userAgent,t=e.indexOf('MSIE ');if(t>0)return parseInt(e.substring(t+5,e.indexOf('.',t)),10);const n=e.indexOf('Trident/');if(n>0){const t=e.indexOf('rv:');return parseInt(e.substring(t+3,e.indexOf('.',t)),10)}const i=e.indexOf('Edge/');return i>0&&parseInt(e.substring(i+5,e.indexOf('.',i)),10)}const n=t.getElementsByTagName('properties')[0];t.getElementsByTagName('sequence')[0].removeChild(n);const i=t.createElement('properties'),r=t.createElement('property'),o=r.cloneNode(!0);r.setAttribute('name','titre'),o.setAttribute('name','description');const s=document.querySelector('#titreImage').innerHTML,a=document.querySelector('#descImage').innerHTML,l=t.createCDATASection(s),c=t.createCDATASection(a);r.appendChild(l),o.appendChild(c),i.appendChild(r),i.appendChild(o),t.getElementsByTagName('sequence')[0].appendChild(i);const d=(new XMLSerializer).serializeToString(t);if(d)if(e()){const e=window.open();e.document.write('<textarea style=\'width: 100%; height: 100%; border:none;\'>'+d+'</textarea>')}else window.open('data:text/xml,'+encodeURIComponent(d),'Test','width=900,height=900,scrollbars=1,resizable=1')}}]);